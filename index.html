<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Colección de videojuegos</title>
  <meta name="description" content="Colección de videojuegos. Buscador por título, plataforma, género y serie." />
  <style>
    :root { --b:#111; --g:#666; --bd:#e6e6e6; --bg:#fafafa; --w:#fff; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--b); background:var(--bg); }
    a{ color:inherit; }

    /* ===== Cabecera común ===== */
    header{ background:var(--w); border-bottom:1px solid var(--bd); position:sticky; top:0; z-index:20; }
    .wrap{ max-width:1200px; margin:0 auto; padding:0 16px; }
    .row{ display:flex; justify-content:space-between; align-items:center; gap:14px; padding:14px 0; }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand strong{ font-size:18px; letter-spacing:.2px; }
    .brand span{ color:var(--g); font-size:12px; }
    .nav{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .nav a{
      text-decoration:none; color:var(--b); font-weight:800;
      padding:8px 10px; border-radius:10px; border:1px solid transparent;
    }
    .nav a:hover{ background:#f7f7f7; border-color:var(--bd); }
    .nav a.active{ background:#f7f7f7; border-color:var(--bd); }

    /* ===== Buscador ===== */
    .searchbar{
      padding:14px 0 16px; border-top:1px solid var(--bd);
      display:flex; gap:10px; align-items:stretch; flex-wrap:wrap;
    }
    .field{ display:flex; flex-direction:column; gap:6px; min-width:180px; flex:1; }
    .field.wide{ flex:2; min-width:260px; }
    label{ font-size:12px; color:var(--g); }
    input, select, button{
      width:100%; padding:10px 12px; border:1px solid var(--bd); border-radius:10px; background:var(--w);
      font-size:14px; appearance:none;
    }
    .select-wrap{ position:relative; }
    .select-wrap:after{
      content:"▾"; position:absolute; right:12px; top:50%; transform:translateY(-50%);
      pointer-events:none; color:var(--g); font-size:12px;
    }
    select{ padding-right:34px; }
    .actions{ display:flex; gap:10px; align-items:end; min-width:220px; }
    button{ cursor:pointer; font-weight:800; }
    button.secondary{ background:#fff; }

    /* ===== Contenido ===== */
    main{ padding:18px 0 30px; }
    .meta{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:8px 0 12px; }
    .count{ color:var(--g); font-size:13px; }
    .status{ color:var(--g); font-size:13px; padding:6px 0 0; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 14px; }
    .chip{
      font-size:12px; padding:6px 10px; border:1px solid var(--bd); border-radius:999px; background:white; color:#333;
      display:inline-flex; gap:8px; align-items:center;
    }
    .chip button{
      width:auto; padding:0; border:none; background:transparent; font-weight:900; cursor:pointer; color:var(--g);
    }

    /* ===== Paginación ===== */
    .pager{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      padding:12px;
      border:1px solid var(--bd);
      border-radius:14px;
      background:#fff;
      margin:10px 0 14px;
    }
    .pager-left, .pager-right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    /* Overrides: en el pager NO queremos width:100% */
    .pager button{ width:auto; padding:10px 12px; }
    .pager select{ width:auto; min-width:110px; padding:10px 12px; }

    .btn{
      border:1px solid var(--bd);
      border-radius:10px;
      background:#fff;
      font-weight:800;
      cursor:pointer;
    }
    .btn:hover{ background:#f7f7f7; }
    .btn[disabled]{ opacity:.45; cursor:not-allowed; }

    .grid{ display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; }
    @media (max-width: 1100px){ .grid{ grid-template-columns: repeat(4, 1fr);} }
    @media (max-width: 700px){
      .grid{ grid-template-columns: repeat(2, 1fr);}
      .actions{ min-width:100%; }
    }

    .card{
      border:1px solid var(--bd); background:white; border-radius:14px; overflow:hidden;
      display:flex; flex-direction:column; min-height: 230px;
    }
    .thumb{ width:100%; aspect-ratio:4/3; object-fit:cover; background:#f2f2f2; display:block; }
    .cbody{ padding:10px 10px 12px; display:flex; flex-direction:column; gap:6px; }
    .title{ font-weight:900; font-size:14px; line-height:1.2; margin:0; }
    .small{ color:var(--g); font-size:12px; }
    .tagrow{ display:flex; flex-wrap:wrap; gap:6px; }
    .tag{ font-size:11px; padding:4px 8px; border:1px solid var(--bd); border-radius:999px; color:#333; }

    a.cardlink{ color:inherit; text-decoration:none; }
    a.cardlink:hover .title{ text-decoration:underline; }

    footer{ padding:18px 0 26px; border-top:1px solid var(--bd); background:#fff; }
    .footrow{ display:flex; flex-wrap:wrap; gap:10px; justify-content:space-between; align-items:center; }
    .to-top{ text-decoration:none; font-weight:800; padding:8px 10px; border-radius:10px; border:1px solid var(--bd); }
    .to-top:hover{ background:#f7f7f7; }
  </style>
</head>
<body>

<header id="top">
  <div class="wrap">
    <div class="row">
      <div class="brand" role="banner">
        <strong>Colección de videojuegos</strong>
        <span>Listado y buscador</span>
      </div>
      <nav class="nav" aria-label="Navegación principal">
        <a href="index.html">Inicio</a>
        <a href="series.html">Series</a>
        <a href="contacto.html">Contacto</a>
      </nav>
    </div>

    <div class="searchbar" role="search" aria-label="Buscador">
      <div class="field wide">
        <label for="q">Título</label>
        <input id="q" type="search" placeholder="Buscar… (p. ej. Dune, Commandos, Doom)" autocomplete="off" />
      </div>

      <div class="field">
        <label for="plataforma">Plataforma</label>
        <div class="select-wrap"><select id="plataforma"></select></div>
      </div>

      <div class="field">
        <label for="genero">Género</label>
        <div class="select-wrap"><select id="genero"></select></div>
      </div>

      <div class="field">
        <label for="serie">Serie</label>
        <div class="select-wrap"><select id="serie"></select></div>
      </div>

      <div class="actions">
        <button id="btnBuscar" type="button">Buscar</button>
        <button id="btnLimpiar" class="secondary" type="button">Limpiar</button>
      </div>
    </div>
    <div class="status wrap" style="padding:0 0 10px;">
      <span class="count">Tip: puedes compartir un listado filtrado: la URL se actualiza con filtros y paginación.</span>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="meta">
      <div class="count" id="count">Cargando…</div>
      <div class="count" id="pageInfo">—</div>
    </div>

    <div class="chips" id="activeFilters" style="display:none;"></div>

    <!-- Paginación (arriba) -->
    <div class="pager" id="pagerTop" style="display:none;">
      <div class="pager-left">
        <button class="btn" id="prevBtnTop" type="button">← Anterior</button>

        <span class="count">Página</span>
        <select id="pageSelectTop" aria-label="Seleccionar página"></select>
        <span class="count" id="totalPagesTop">de —</span>

        <button class="btn" id="nextBtnTop" type="button">Siguiente →</button>
      </div>

      <div class="pager-right">
        <label for="pageSizeTop" class="count">Por página</label>
        <select id="pageSizeTop">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>

    <div class="grid" id="grid" aria-live="polite"></div>

    <!-- Paginación (abajo) -->
    <div class="pager" id="pagerBottom" style="display:none;">
      <div class="pager-left">
        <button class="btn" id="prevBtnBottom" type="button">← Anterior</button>

        <span class="count">Página</span>
        <select id="pageSelectBottom" aria-label="Seleccionar página"></select>
        <span class="count" id="totalPagesBottom">de —</span>

        <button class="btn" id="nextBtnBottom" type="button">Siguiente →</button>
      </div>

      <div class="pager-right">
        <label for="pageSizeBottom" class="count">Por página</label>
        <select id="pageSizeBottom">
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
        </select>
      </div>
    </div>
  </div>
</main>

<footer>
  <div class="wrap">
    <div class="footrow">
      <p class="count" style="margin:0;">Colección de videojuegos</p>
      <a class="to-top" href="#top">Subir</a>
    </div>
  </div>
</footer>

<script>
  /* ===== MENÚ ACTIVO ===== */
  (function markActiveNav(){
    const current = (location.pathname.split("/").pop() || "index.html").toLowerCase();
    document.querySelectorAll(".nav a").forEach(a => {
      const href = (a.getAttribute("href") || "").toLowerCase();
      if (href === current) a.classList.add("active");
    });
  })();

  const state = {
    juegos: [],
    q: "",
    plataforma: "",
    genero: "",
    serie: "",
    page: 1,
    pageSize: 25
  };

  const elQ = document.getElementById("q");
  const elPlat = document.getElementById("plataforma");
  const elGen = document.getElementById("genero");
  const elSerie = document.getElementById("serie");
  const elGrid = document.getElementById("grid");
  const elCount = document.getElementById("count");
  const elPageInfo = document.getElementById("pageInfo");
  const elActive = document.getElementById("activeFilters");
  const btnBuscar = document.getElementById("btnBuscar");
  const btnLimpiar = document.getElementById("btnLimpiar");

  const pagerTop = document.getElementById("pagerTop");
  const pagerBottom = document.getElementById("pagerBottom");

  const prevBtnTop = document.getElementById("prevBtnTop");
  const nextBtnTop = document.getElementById("nextBtnTop");
  const pageSelectTop = document.getElementById("pageSelectTop");
  const totalPagesTopEl = document.getElementById("totalPagesTop");
  const pageSizeTop = document.getElementById("pageSizeTop");

  const prevBtnBottom = document.getElementById("prevBtnBottom");
  const nextBtnBottom = document.getElementById("nextBtnBottom");
  const pageSelectBottom = document.getElementById("pageSelectBottom");
  const totalPagesBottomEl = document.getElementById("totalPagesBottom");
  const pageSizeBottom = document.getElementById("pageSizeBottom");

  function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }
  function uniqSorted(arr){
    return Array.from(new Set(arr.filter(Boolean))).sort((a,b)=>a.localeCompare(b, "es"));
  }
  function slugFromUrl(url){
    const u = (url || "").replace(/^\/+/, "");
    const parts = u.split("/").filter(Boolean);
    return parts.length ? parts[parts.length - 1] : "";
  }
  function thumbUrl(game){
    const base = game.url || "";
    return base.endsWith("/") ? (base + "img/001.jpg") : (base + "/img/001.jpg");
  }
  function setSelectOptions(selectEl, values, placeholder){
    selectEl.innerHTML = "";
    const opt0 = document.createElement("option");
    opt0.value = "";
    opt0.textContent = placeholder;
    selectEl.appendChild(opt0);

    for (const v of values){
      const opt = document.createElement("option");
      opt.value = v;
      opt.textContent = v;
      selectEl.appendChild(opt);
    }
  }

  function readQuery(){
    const u = new URL(location.href);
    const get = (k) => u.searchParams.get(k) || "";

    const page = parseInt(get("page") || "1", 10);
    const pageSize = parseInt(get("pageSize") || "25", 10);
    const allowed = [10,25,50,100];

    return {
      q: get("q"),
      plataforma: get("plataforma"),
      genero: get("genero"),
      serie: get("serie"),
      page: (Number.isFinite(page) && page > 0) ? page : 1,
      pageSize: allowed.includes(pageSize) ? pageSize : 25
    };
  }

  function writeQuery(){
    const u = new URL(location.href);
    const sp = u.searchParams;

    function setOrDelete(key, val){
      if (val !== null && val !== undefined && String(val).length) sp.set(key, String(val));
      else sp.delete(key);
    }

    setOrDelete("q", elQ.value.trim());
    setOrDelete("plataforma", elPlat.value);
    setOrDelete("genero", elGen.value);
    setOrDelete("serie", elSerie.value);

    sp.set("page", String(state.page));
    sp.set("pageSize", String(state.pageSize));

    history.replaceState({}, "", u.toString());
  }

  function syncUIFromQuery(query){
    elQ.value = query.q || "";
    elPlat.value = query.plataforma || "";
    elGen.value = query.genero || "";
    elSerie.value = query.serie || "";
    state.page = query.page || 1;
    state.pageSize = query.pageSize || 25;

    pageSizeTop.value = String(state.pageSize);
    pageSizeBottom.value = String(state.pageSize);
  }

  function applyFromUI(){
    state.q = norm(elQ.value);
    state.plataforma = norm(elPlat.value);
    state.genero = norm(elGen.value);
    state.serie = norm(elSerie.value);
  }

  function matches(game){
    if (state.q && !norm(game.titulo).includes(state.q)) return false;

    if (state.plataforma){
      const vals = (game.plataforma || []).map(norm);
      if (!vals.includes(state.plataforma)) return false;
    }
    if (state.genero){
      const vals = (game.genero || []).map(norm);
      if (!vals.includes(state.genero)) return false;
    }
    if (state.serie){
      const vals = (game.serie || []).map(norm);
      if (!vals.includes(state.serie)) return false;
    }
    return true;
  }

  function renderActiveFilters(){
    const items = [];
    if (state.q) items.push({ k:"Título", v: elQ.value.trim(), clear: () => { elQ.value=""; }});
    if (state.plataforma) items.push({ k:"Plataforma", v: elPlat.value, clear: () => { elPlat.value=""; }});
    if (state.genero) items.push({ k:"Género", v: elGen.value, clear: () => { elGen.value=""; }});
    if (state.serie) items.push({ k:"Serie", v: elSerie.value, clear: () => { elSerie.value=""; }});

    elActive.innerHTML = "";
    if (!items.length){
      elActive.style.display = "none";
      return;
    }
    elActive.style.display = "flex";

    for (const it of items){
      const chip = document.createElement("div");
      chip.className = "chip";
      chip.innerHTML = `<strong>${it.k}:</strong> <span>${it.v}</span>`;
      const x = document.createElement("button");
      x.type = "button";
      x.title = "Quitar filtro";
      x.textContent = "×";
      x.addEventListener("click", () => {
        it.clear();
        doSearch(true);
      });
      chip.appendChild(x);
      elActive.appendChild(chip);
    }
  }

  function renderPager(totalItems){
    const totalPages = Math.max(1, Math.ceil(totalItems / state.pageSize));
    if (state.page > totalPages) state.page = totalPages;

    const show = totalPages > 1;
    pagerTop.style.display = show ? "" : "none";
    pagerBottom.style.display = show ? "" : "none";

    const canPrev = state.page > 1;
    const canNext = state.page < totalPages;

    prevBtnTop.disabled = !canPrev;
    prevBtnBottom.disabled = !canPrev;
    nextBtnTop.disabled = !canNext;
    nextBtnBottom.disabled = !canNext;

    totalPagesTopEl.textContent = `de ${totalPages}`;
    totalPagesBottomEl.textContent = `de ${totalPages}`;

    function fillPageSelect(sel){
      const currentVal = String(state.page);
      sel.innerHTML = "";
      for (let p = 1; p <= totalPages; p++){
        const opt = document.createElement("option");
        opt.value = String(p);
        opt.textContent = String(p);
        sel.appendChild(opt);
      }
      sel.value = currentVal;
    }

    fillPageSelect(pageSelectTop);
    fillPageSelect(pageSelectBottom);

    pageSizeTop.value = String(state.pageSize);
    pageSizeBottom.value = String(state.pageSize);

    prevBtnTop.onclick = prevBtnBottom.onclick = () => {
      if (state.page > 1){
        state.page -= 1;
        writeQuery();
        render();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    };

    nextBtnTop.onclick = nextBtnBottom.onclick = () => {
      if (state.page < totalPages){
        state.page += 1;
        writeQuery();
        render();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    };

    function onPageSelectChange(val){
      const p = parseInt(val, 10);
      if (!Number.isFinite(p) || p < 1 || p > totalPages) return;
      state.page = p;
      writeQuery();
      render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    pageSelectTop.onchange = () => onPageSelectChange(pageSelectTop.value);
    pageSelectBottom.onchange = () => onPageSelectChange(pageSelectBottom.value);

    function onPageSizeChange(val){
      const n = parseInt(val, 10);
      const allowed = [10,25,50,100];
      state.pageSize = allowed.includes(n) ? n : 25;
      state.page = 1;
      writeQuery();
      render();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    pageSizeTop.onchange = () => onPageSizeChange(pageSizeTop.value);
    pageSizeBottom.onchange = () => onPageSizeChange(pageSizeBottom.value);

    elPageInfo.textContent = `Página ${state.page} / ${totalPages} · ${state.pageSize}/pág`;
  }

  function render(){
    renderActiveFilters();

    const filtered = state.juegos.filter(matches);
    const total = filtered.length;

    const totalPages = Math.max(1, Math.ceil(total / state.pageSize));
    if (state.page > totalPages) state.page = totalPages;

    const start = (state.page - 1) * state.pageSize;
    const pageItems = filtered.slice(start, start + state.pageSize);

    elCount.textContent = `${total} / ${state.juegos.length} juegos`;

    renderPager(total);

    elGrid.innerHTML = "";
    for (const g of pageItems){
      const slug = slugFromUrl(g.url);

      const a = document.createElement("a");
      a.className = "cardlink";
      a.href = `detalle.html?juego=${encodeURIComponent(slug)}&returnUrl=${encodeURIComponent(location.pathname + location.search)}`;

      const card = document.createElement("article");
      card.className = "card";

      const img = document.createElement("img");
      img.className = "thumb";
      img.loading = "lazy";
      img.alt = g.titulo || "Juego";
      img.src = thumbUrl(g);
      img.onerror = () => { img.removeAttribute("src"); img.style.background = "#f2f2f2"; };

      const body = document.createElement("div");
      body.className = "cbody";

      const title = document.createElement("h3");
      title.className = "title";
      title.textContent = g.titulo || "(Sin título)";

      const small = document.createElement("div");
      small.className = "small";
      small.textContent = [
        (g.plataforma || []).join(", "),
        (g.serie || []).filter(s=>s!=="Todos").join(" · ")
      ].filter(Boolean).join(" — ");

      const tagrow = document.createElement("div");
      tagrow.className = "tagrow";
      for (const t of (g.tags || []).slice(0,3)){
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = t;
        tagrow.appendChild(span);
      }

      body.appendChild(title);
      if (small.textContent) body.appendChild(small);
      if (tagrow.childNodes.length) body.appendChild(tagrow);

      card.appendChild(img);
      card.appendChild(body);
      a.appendChild(card);
      elGrid.appendChild(a);
    }
  }

  function doSearch(resetPage){
    applyFromUI();
    if (resetPage) state.page = 1;
    writeQuery();
    render();
  }

  function bind(){
    btnBuscar.addEventListener("click", () => doSearch(true));
    elQ.addEventListener("keydown", (e) => { if (e.key === "Enter") doSearch(true); });

    for (const s of [elPlat, elGen, elSerie]){
      s.addEventListener("change", () => doSearch(true));
    }

    btnLimpiar.addEventListener("click", () => {
      elQ.value = "";
      elPlat.value = "";
      elGen.value = "";
      elSerie.value = "";
      doSearch(true);
    });

    window.addEventListener("popstate", () => {
      const q = readQuery();
      syncUIFromQuery(q);
      applyFromUI();
      render();
    });
  }

  async function init(){
    bind();

    const res = await fetch("juegos.json", { cache: "no-store" });
    const data = await res.json();
    state.juegos = Array.isArray(data) ? data : (data.juegos || []);

    state.juegos.sort((a,b) => {
      const na = Number.isFinite(+a.num) ? +a.num : Infinity;
      const nb = Number.isFinite(+b.num) ? +b.num : Infinity;
      if (na !== nb) return na - nb;
      return (a.titulo||"").localeCompare((b.titulo||""), "es");
    });

    const plataformas = uniqSorted(state.juegos.flatMap(j => j.plataforma || []));
    const generos = uniqSorted(state.juegos.flatMap(j => j.genero || []));
    const series = uniqSorted(state.juegos.flatMap(j => (j.serie || []).filter(s => s !== "Todos")));

    setSelectOptions(elPlat, plataformas, "Todas");
    setSelectOptions(elGen, generos, "Todos");
    setSelectOptions(elSerie, series, "Todas");

    const q = readQuery();
    syncUIFromQuery(q);

    applyFromUI();
    writeQuery();
    render();
  }

  init().catch(err => {
    console.error(err);
    elCount.textContent = "Error cargando juegos.json (revisa ruta y formato).";
  });
</script>

</body>
</html>
