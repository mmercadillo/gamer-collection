<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cat√°logo de Videojuegos</title>
  <meta name="description" content="Cat√°logo personal de videojuegos de PC (Big Box, FX, BestSeller, etc.)." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <header class="sticky top-0 z-10 backdrop-blur bg-white/80 border-b border-zinc-200">
    <div class="max-w-6xl mx-auto px-4 py-3 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
      <a href="./" class="text-2xl font-bold tracking-tight">üéÆ Cat√°logo de Videojuegos</a>
      <nav class="text-sm text-zinc-600 flex gap-4">
        <a class="hover:underline" href="#/list">Listado</a>
        <a class="hover:underline" href="#/series">Series</a>
        <a class="hover:underline" href="#/about">Acerca de</a>
      </nav>
    </div>
  </header>

  <main id="app" class="max-w-6xl mx-auto px-4 py-6"></main>

  <footer class="max-w-6xl mx-auto px-4 py-10 text-center text-sm text-zinc-500">
    Hecho con ‚ù§Ô∏è para organizar mi colecci√≥n. Repo: <span class="font-mono">GitHub Pages</span>.
  </footer>

  <script>
  // Utilidades b√°sicas
  const by = (sel, ctx=document) => ctx.querySelector(sel);
  const all = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const slugify = s => (s||'').toString().toLowerCase()
    .normalize('NFD').replace(/[ÃÄ-ÕØ]/g,'')
    .replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
  const debounce = (fn, wait = 300) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; };

  const DATA_URL = 'juegos.json';
  const state = { juegos: [], cargado: false };

  async function loadData() {
    if (state.cargado) return state.juegos;
    try {
      const res = await fetch(DATA_URL, {cache: 'no-store'});
      if (!res.ok) throw new Error('No se pudo cargar ' + DATA_URL);
      const data = await res.json();
      state.juegos = Array.isArray(data) ? data : (data.juegos || []);
      state.cargado = true;
      return state.juegos;
    } catch (e) {
      console.error(e);
      state.juegos = [];
      state.cargado = true;
      return [];
    }
  }

  // ===== VISTAS =====
  function renderAbout(){
    return `<section class="prose max-w-none"><h1 class="text-3xl font-semibold mb-4">Acerca de</h1><p>SPA est√°tica que carga los datos desde <code>${DATA_URL}</code>.</p></section>`;
  }

  function renderSeries(juegos){
    const seriesMap = new Map();
    juegos.forEach(j => (j.serie||[]).forEach(s => {
      const k = (s||'').trim(); if(!k) return;
      if(!seriesMap.has(k)) seriesMap.set(k, []);
      seriesMap.get(k).push(j);
    }));
    if (!seriesMap.size) return `<p class="text-zinc-600">No hay series registradas todav√≠a.</p>`;
    return `
      <h1 class="text-3xl font-semibold mb-6">Series</h1>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        ${[...seriesMap.entries()].map(([serie, arr])=>`
          <a href="#/list?serie=${encodeURIComponent(serie)}" class="block p-5 rounded-2xl border bg-white hover:shadow-sm">
            <div class="text-lg font-semibold">${serie}</div>
            <div class="text-sm text-zinc-500">${arr.length} juego(s)</div>
          </a>`).join('')}
      </div>`;
  }

  function renderList(juegos, params){
    const tTitulo = (params.get('titulo')||'').trim().toLowerCase();
    const fPlat = (params.get('plataforma')||'').toLowerCase();
    const fSerie = (params.get('serie')||'').toLowerCase();
    const fTag = (params.get('tag')||'').toLowerCase();
    const fGenero = (params.get('genero')||'').toLowerCase();

    let res = juegos.filter(j => {
      const hayTitulo = !tTitulo || (j.titulo||'').toLowerCase().includes(tTitulo);
      const hayPlat = !fPlat || (j.plataforma||[]).some(p => (p||'').toLowerCase().includes(fPlat));
      const haySerie = !fSerie || (j.serie||[]).some(s => (s||'').toLowerCase().includes(fSerie));
      const hayTag = !fTag || (j.tags||[]).some(tag => (tag||'').toLowerCase().includes(fTag));
      const hayGenero = !fGenero || (j.genero||[]).some(g => (g||'').toLowerCase().includes(fGenero));
      return hayTitulo && hayPlat && haySerie && hayTag && hayGenero;
    });

    res.sort((a,b) => a.titulo.localeCompare(b.titulo, 'es'));

    const plataformas = [...new Set(juegos.flatMap(j => j.plataforma||[]))].sort((a,b)=>a.localeCompare(b,'es'));
    const series = [...new Set(juegos.flatMap(j => j.serie||[]))].filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
    const tags = [...new Set(juegos.flatMap(j => j.tags||[]))].filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));
    const generos = [...new Set(juegos.flatMap(j => j.genero||[]))].filter(Boolean).sort((a,b)=>a.localeCompare(b,'es'));

    const hayFiltros = tTitulo || fPlat || fSerie || fTag || fGenero;

    return `
      <section class="mb-6">
        <div class="flex items-end justify-between gap-3 mb-2">
          <h1 class="text-3xl font-semibold">Listado</h1>
          <div class="text-sm text-zinc-600">${res.length} resultado(s)</div>
        </div>
        <form id="filters" class="grid gap-3 p-4 rounded-2xl border bg-white shadow-sm">
          <input name="titulo" value="${tTitulo}" placeholder="Buscar por t√≠tulo" class="w-full p-4 text-lg rounded-2xl border" />
          <div class="grid gap-3 md:grid-cols-4">
            <select name="genero" class="w-full p-3 rounded-2xl border">
              <option value="">Todos los g√©neros</option>
              ${generos.map(g=>`<option ${fGenero===g.toLowerCase()? 'selected':''}>${g}</option>`).join('')}
            </select>
            <select name="plataforma" class="w-full p-3 rounded-2xl border">
              <option value="">Todas las plataformas</option>
              ${plataformas.map(p=>`<option ${fPlat===p.toLowerCase()? 'selected':''}>${p}</option>`).join('')}
            </select>
            <select name="serie" class="w-full p-3 rounded-2xl border">
              <option value="">Todas las series</option>
              ${series.map(s=>`<option ${fSerie===s.toLowerCase()? 'selected':''}>${s}</option>`).join('')}
            </select>
            <select name="tag" class="w-full p-3 rounded-2xl border">
              <option value="">Todos los tags</option>
              ${tags.map(t=>`<option ${fTag===t.toLowerCase()? 'selected':''}>${t}</option>`).join('')}
            </select>
          </div>
        </form>
        ${hayFiltros ? `<div class="mt-2"><button id="clearFilters" class="text-xs px-3 py-1 rounded-full bg-zinc-100 border">Limpiar filtros</button></div>` : ''}
      </section>

      <section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        ${res.map(j => card(j)).join('') || `<p class="text-zinc-600">No hay resultados.</p>`}
      </section>
    `;
  }

  function card(j) {
  const slug = encodeURIComponent(j.url);
  const plataformas = (j.plataforma||[]).join(' ¬∑ ');
  const genero = (j.genero||[]).join(' ¬∑ ');
  const serie = (j.serie||[]).join(' ¬∑ ');

  const rutaBase = (j.url || '').replace(/\/+$/, '');
  const rutaImgs = rutaBase + '/img/';
  const extensiones = ['.jpg', '.jpeg', '.png', '.webp'];
  let miniaturaHTML = '';

  for (let ext of extensiones) {
    const testSrc = rutaImgs + '001' + ext;
    miniaturaHTML += `
      <img src="${testSrc}" alt="Miniatura de ${j.titulo}" class="mt-3 aspect-video object-cover w-full rounded-xl border" loading="lazy" onerror="this.style.display='none';">
    `;
  }

  return `
      <a class="group block p-5 rounded-2xl border bg-white hover:shadow-sm transition" href="#/game/${slug}">
        <div class="flex items-start justify-between gap-3">
          <h3 class="text-lg font-semibold leading-tight">${j.titulo}</h3>
          ${serie ? `<span class="text-[10px] px-2 py-1 rounded-full bg-zinc-100 text-zinc-700">${serie}</span>` : ''}
        </div>
        ${miniaturaHTML}<p class="mt-2 text-sm text-zinc-600 line-clamp-2">${j.descripcion||''}</p>
        <div class="mt-3 text-xs text-zinc-500">${genero || '&nbsp;'}</div>
        <div class="mt-1 text-xs text-zinc-500">${plataformas || '&nbsp;'}</div>
      </a>
    `;
  }

  // === Vista detalle del juego con galer√≠a 001..015 ===
  function renderGame(j) {
    const plataformas = (j.plataforma||[]).join(' ¬∑ ');
    const genero = (j.genero||[]).join(' ¬∑ ');
    const dev = (j.desarrollador||[]).join(', ');
    const dist = (j.distribuidor||[]).join(', ');
    const serie = (j.serie||[]).join(' ¬∑ ');
    const ean = (j.ean||[]).join(', ');
    const incluye = (j.incluye||[]);
    const baseUrl = (j.url || '').replace(/\/+$/, '');
    const rutaImgs = (baseUrl ? baseUrl + '/' : '') + 'img/';
    
    return `
      <article class="grid gap-6 md:grid-cols-2">
        <section>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3" data-gallery-ruta="${rutaImgs}"></div>
          <div class="mt-3 text-xs text-zinc-500">Coloca im√°genes en <code>${rutaImgs}</code> numeradas <code>001</code> a <code>015</code> (JPG/PNG/JPEG).</div>
        </section>
        <section>
          <h1 class="text-3xl font-semibold">${j.titulo}</h1>
          ${serie? `<div class="mt-1 text-xs px-2 py-1 rounded-full bg-zinc-100 inline-block">${serie}</div>`:''}
          <p class="mt-4 text-zinc-700">${j.descripcion||''}</p>
          <dl class="mt-6 grid gap-2 text-sm">
            ${genero? `<div class="grid grid-cols-3"><dt class="text-zinc-500">G√©nero</dt><dd class="col-span-2">${genero}</dd></div>`:''}
            ${plataformas? `<div class="grid grid-cols-3"><dt class="text-zinc-500">Plataforma</dt><dd class="col-span-2">${plataformas}</dd></div>`:''}
            ${dev? `<div class="grid grid-cols-3"><dt class="text-zinc-500">Desarrollador</dt><dd class="col-span-2">${dev}</dd></div>`:''}
            ${dist? `<div class="grid grid-cols-3"><dt class="text-zinc-500">Distribuidor</dt><dd class="col-span-2">${dist}</dd></div>`:''}
            ${ean? `<div class="grid grid-cols-3"><dt class="text-zinc-500">EAN</dt><dd class="col-span-2">${ean}</dd></div>`:''}
          </dl>
          ${incluye.length? `
            <div class="mt-4">
              <div class="text-sm text-zinc-500">Incluye</div>
              <ul class="list-disc pl-5 text-sm">${incluye.map(i=>`<li>${i}</li>`).join('')}</ul>
            </div>`:''}

          <div class="mt-6 flex gap-2">
            <a href="#/list" class="px-4 py-2 rounded-xl border">‚Üê Volver al listado</a>
            
          </div>
        </section>
      </article>
    `;
  }

  function initGallery() {
    const cont = document.querySelector('[data-gallery-ruta]');
    if (!cont) return;
    const ruta = cont.getAttribute('data-gallery-ruta');
    const exts = ['.jpg', '.jpeg', '.png', '.webp'];
    let loaded = 0;

    function addThumb(srcAbs, alt) {
      const img = new Image();
      img.loading = 'lazy';
      img.alt = alt;
      img.className = 'w-full object-cover rounded-xl';

      const a = document.createElement('a');
      a.href = srcAbs;
      a.target = '_blank';
      a.rel = 'noopener';
      a.className = 'block overflow-hidden rounded-xl border bg-white';
      a.appendChild(img);

      img.src = srcAbs;
      cont.appendChild(a);
      loaded++;
    }

    for (let i = 1; i <= 15; i++) {
      const num = String(i).padStart(3, '0');
      let idx = 0;

      const tryNext = () => {
        if (idx >= exts.length) return;
        const candidate = ruta + num + exts[idx++];
        const probe = new Image();
        probe.onload = () => {
          console.log("[ok]", candidate);
          addThumb(candidate, num);
        };
        probe.onerror = () => {
          console.warn("[fail]", candidate);
          tryNext();
        };
        console.log("[test]", candidate);
        probe.src = candidate;
      };

      tryNext();
    }

    setTimeout(() => {
      if (loaded === 0) {
        cont.innerHTML = `<div class="text-sm text-zinc-500">No se encontraron im√°genes en <code>${ruta}</code></div>`;
      }
    }, 1000);
  }

  // ===== ROUTER =====
  function parseParams(str) {
    const u = new URL('https://x/?'+(str||''));
    return u.searchParams;
  }
  function currentRoute() {
    const hash = location.hash || '#/list';
    const [path, qs] = hash.split('?');
    return { path, params: parseParams(qs) };
  }

  async function render() {
    const root = by('#app');
    const { path, params } = currentRoute();
    const juegos = await loadData();

    if (path.startsWith('#/about')) { root.innerHTML = renderAbout(); return; }
    if (path.startsWith('#/series')) { root.innerHTML = renderSeries(juegos); return; }

    if (path.startsWith('#/list')) {
      root.innerHTML = renderList(juegos, params);
      const form = by('#filters');
      if (form) {
        const apply = () => {
          const fd = new FormData(form);
          const sp = new URLSearchParams();
          for (const [k, v] of fd.entries()) {
            const val = (v || '').toString().trim();
            if (val) sp.set(k, val);
          }
          location.hash = `#/list${sp.toString()? ('?'+sp.toString()):''}`;
        };
        const debouncedApply = debounce(apply, 300);
        form.addEventListener('input', (e) => { if (e.target && e.target.name === 'titulo') debouncedApply(); });
        form.addEventListener('change', (e) => { if (e.target && (e.target.tagName === 'SELECT')) apply(); });
        const clearBtn = by('#clearFilters');
        if (clearBtn) clearBtn.addEventListener('click', () => { location.hash = '#/list'; });
      }
      return;
    }

    if (path.startsWith('#/game/')) {
      const slug = decodeURIComponent(path.replace('#/game/',''));
      const j = juegos.find(x => x.url === slug);
      if (!j) { root.innerHTML = `<p class="text-zinc-600">Juego no encontrado.</p>`; return; }
      root.innerHTML = renderGame(j);
      initGallery();
      return;
    }

    location.hash = '#/list';
  }

  window.addEventListener('hashchange', render);
  render();
  </script>
</body>
</html>
